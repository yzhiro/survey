# PHP製 アンケート＆自動統計分析アプリケーション

PHPとMySQLを学びながら、アンケートの収集から統計分析、結果の可視化までをリアルタイムで行うWebアプリケーションを作ってみました。

誰でもアンケートフォーム (`index.php`) から回答を送信でき、そのデータは安全にデータベースへ保存されます。

また、アカウント登録・ログイン機能を実装しており、権限に応じて専用の管理画面にアクセスできます。管理画面では、回答データの集計・分析レポート (`analysis.php`) を見たり、データベースの生データ (`view_data.php`) を直接操作したりすることが可能です。

## ✨ 主な機能

特にこだわって実装した主な機能です。

  * **アンケートフォーム**: 直感的に回答できるUIを意識しました。回答者の属性（年齢、性別など）と、各質問への5段階評価を収集します。
  * **安全なデータベース連携**: `submit.php` でフォームデータを受け取り、しっかりバリデーションとサニタイズ処理をします。その上で、PDOのプリペアドステートメントを使って安全にMySQLデータベースへ保存するようにしています。
  * **多階層の認証機能**:
      * **3種類の権限**: **管理者(admin)**、**中間管理者(editor)**、**一般(viewer)** の3つの役割（ロール）を設け、それぞれに異なるアクセス権を付与しました。
      * **アカウント管理**: 新規登録、ログイン・ログアウト、パスワード変更といった基本的な機能を実装しました。
      * **セキュアなパスワード**: パスワードは `password_hash()` でハッシュ化して安全に保管します。
  * **リアルタイム分析レポート (`analysis.php`)**:
      * **全体集計**: 回答者数や属性（性別、年代、年収層）の分布を円グラフでリアルタイムに可視化します。
      * **レーダーチャート**: 全質問の平均スコアを一覧表示し、全体の傾向をパッと見て把握できるようにしました。
      * **統計分析**:
          * **一元配置分散分析 (ANOVA)**: 性別や年代といった属性が、回答に意味のある差を与えているか検定します。
          * **多重比較 (テューキーのHSD法)**: ANOVAで有意差があった場合に、じゃあ具体的にどのグループ間に差があるの？というのを明らかにします。
          * **二元配置分散分析 (ANOVA)**: 2つの属性が回答に与える影響や、その交互作用を分析できるようにしました。
  * **DB直接操作機能 (`view_data.php`, `manage_users.php`)**:
      * **生データ管理**: アプリケーションの中から直接、アンケートの全生データをテーブル形式で確認・**編集**・**削除**できます。
      * **ユーザー権限管理**: 管理者権限を持つユーザーは、他のユーザーの権限を変更したり、ユーザーを削除したりすることが可能です。
  * **CSVダウンロード機能**:
      * **権限に応じた出力**: **中間管理者(editor)** はアンケート結果のみ、**管理者(admin)** はアンケート結果とユーザーリストの両方をCSV形式でダウンロードできます。
      * **文字化け対策**: Excelで開いても文字化けしないよう、BOM付きのUTF-8でファイルを出力するようにしました。
  * **動的なUI**: UIには[Tailwind CSS](https://tailwindcss.com/)を使い、PCでもスマートフォンでも見やすいレスポンシブデザインにしました。また、[Chart.js](https://www.chartjs.org/)を利用して、分析結果をインタラクティブなグラフとして描画しています。

## 🛡️ 堅牢なセキュリティ設計

このアプリを開発する上で、**セキュリティの確保**に最も力を注ぎました。外部からの攻撃を防ぎ、ユーザーの情報を守るため、以下の対策を徹底的に実装しています。

  * **SQLインジェクション対策**: ユーザーからの入力をデータベースに渡すすべての処理（回答送信、ユーザー登録、ログイン、データ更新など）で、**PDOのプリペアドステートメント**を100%使用しています。これにより、SQLインジェクションの脆弱性を根本的に無くしました。

  * **クロスサイトスクリプティング (XSS) 対策**: データベースから取得した値を画面に出力する際は、必ず自作のヘルパー関数 `h()` を通しています。これでHTMLタグやJavaScriptコードを無害化（エスケープ）して、XSS攻撃を完全に防ぎます。

  * **CSRF (クロスサイトリクエストフォージェリ) 対策**: ユーザー登録、ログイン、データ削除といった重要な処理を行うすべてのフォームに、**CSRFトークン**を埋め込んでいます。サーバー側でこのトークンを検証することで、意図しないリクエストが外部から送信されるのを防ぎ、アプリケーションを保護します。

  * **セキュアなセッション管理**: `HttpOnly` や `Secure` 属性を付けたCookie、定期的なセッションIDの再生成など、セッションハイジャック対策を施した独自の `session_start_secure()` 関数を導入し、セッションの安全性を高めています。

  * **安全なパスワード保管**: ユーザーのパスワードは、PHP標準の `password_hash()` 関数を使って強力なハッシュ値を生成し、データベースに保存します。生のパスワードは一切保存しないので、万が一データベースが漏洩しても、パスワードそのものが流出することはありません。ログイン認証時には `password_verify()` で検証します。

## 🛠️ 使用技術

  * **バックエンド**: PHP
  * **データベース**: MySQL
  * **フロントエンド**: HTML, JavaScript, Tailwind CSS
  * **ライブラリ**: Chart.js (グラフ描画)

## 📂 ファイル構成

```
.
├── index.php         # アンケートフォーム画面
├── submit.php        # フォームデータ処理・DB登録
├── thanks.php        # アンケート回答完了画面
│
├── login.php         # ログイン画面
├── register.php      # 新規ユーザー登録画面
├── register_process.php # ユーザー登録処理
├── authenticate.php  # 認証処理
├── logout.php        # ログアウト処理
├── change_password.php # パスワード変更画面
├── change_password_process.php # パスワード変更処理
│
├── analysis.php      # 【要ログイン】分析レポート画面
├── view_data.php     # 【管理者/編集者】DBデータ表示画面
├── edit_form.php     # 【管理者/編集者】データ編集フォーム
├── edit_data.php     # 【管理者/編集者】データ更新処理
├── delete_data.php   # 【管理者/編集者】データ削除処理
│
├── manage_users.php  # 【管理者】ユーザー管理画面
├── update_user_role.php # 【管理者】ユーザー権限更新処理
├── delete_user.php   # 【管理者】ユーザー削除処理
│
├── download.php      # 【要ログイン】CSVダウンロード処理
│
├── db_connect.php    # DB接続情報（※Git管理外）
└── README.md         # このファイル
```

## 今後の展望

  * 分析結果のPDFエクスポート機能
  * より多様なグラフ（箱ひげ図など）の追加
  * デザインのさらなる改善

フィードバックや改善案などあれば、ぜひ教えてください！